#!/usr/bin/env ruby

require "docopt"
require_relative "../lib/scanny"
include Scanny::CLI

doc = "Scanny RoR secutiry scanner

Usage:
  scanny [options] <files_or_dirs>...

Options:
  -h, --help                        Show this screen.
  -i <check>, --include <check>     Include check to scanning process (file or directory).
  -d <check>, --disable <check>     Disable check class from scanning process.
  -f <format>, --format <format>    Output format (stdout, html, xml) [default: stdout].
  -s, --strict                      Enable strict mode (for security guys) [default: false]."


options = Docopt(doc)

require_checks(options[:include])

runner  = runner_with_custom_checks(options[:disable], options[:strict])
issues  = 0

files = build_paths.map { |arg| Dir[arg].to_a }.flatten

runner.run(*files)

runner.checks_data.each do |check_data|
  case options[:format]
    when 'xml'
      Scanny::Reporters::XMLReporter.new(check_data).report
    when 'stdout'
      Scanny::Reporters::SimpleReporter.new(check_data).report
    else
      raise "Format #{options[:format]} is not supported"
  end
  issues += check_data[:issues].size
end
puts

if issues == 0
  puts "Found no issues."
  exit 0
else
  puts "Found #{issues} issues."
  exit 1
end